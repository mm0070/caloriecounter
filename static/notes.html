<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Calorie Tracker - Notes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/static/favicon.png" type="image/png" />
  <link rel="apple-touch-icon" href="/static/apple-touch-icon.png" sizes="180x180" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-1f2bC4dQwDFiXBJgp7wa9u0edPFpKnz03Wx/89ZbduCMsZ/HXXIQK5vCk1vZ1tcHTul3e8DqRLH0PHJrL6R1g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="shell">
  <header class="header">
    <h1 style="margin:0;display:flex;align-items:center;gap:0.45rem;"><i class="fa-solid fa-note-sticky"></i> Notes</h1>
    <nav class="nav">
      <a href="/static/index.html" class="nav-btn"><i class="fa-solid fa-bolt"></i> Today</a>
      <a href="/static/history.html" class="nav-btn"><i class="fa-solid fa-clock-rotate-left"></i> History</a>
      <a href="/static/notes.html" class="nav-btn"><i class="fa-solid fa-note-sticky"></i> Notes</a>
    </nav>
  </header>

  <div class="card">
    <h2><i class="fa-solid fa-pen"></i> Shorthand notes</h2>
    <p class="small">Add a shorthand and the detailed description it should map to. Example: title "protein shake", content "400ml milk, 35g protein powder, 5g cocoa". Notes are sent to the nutrition model with each entry so it can interpret them (even with small typos). Click a saved note to edit or delete it.</p>
    <div class="form-grid">
      <div>
        <label class="field-label" for="note-title">Title</label>
        <input id="note-title" type="text" placeholder="protein shake" />
      </div>
      <div>
        <label class="field-label" for="note-content">Content</label>
        <textarea id="note-content" placeholder="400ml milk, 35g protein powder, 5g cocoa"></textarea>
      </div>
      <button id="save-btn" class="primary-btn">Save note</button>
      <div class="error" id="error"></div>
    </div>
  </div>

  <div class="card">
    <h2><i class="fa-solid fa-list"></i> Saved notes</h2>
    <ul class="notes-list" id="notes"></ul>
  </div>

  </div>

  <script>
    const notesEl = document.getElementById("notes");
    const titleInput = document.getElementById("note-title");
    const contentInput = document.getElementById("note-content");
    const saveBtn = document.getElementById("save-btn");
    const errorEl = document.getElementById("error");
    let hasForcedReload = false;

    function forceFreshLoad(reason) {
      if (hasForcedReload) return;
      hasForcedReload = true;
      location.reload();
    }

    window.addEventListener("pageshow", (e) => {
      if (e.persisted) forceFreshLoad("pageshow");
    });
    document.addEventListener("visibilitychange", () => {
      if (!document.hidden) forceFreshLoad("visibilitychange");
    });

    let editingId = null;

    function renderNotes(notes) {
      if (!notes.length) {
        notesEl.innerHTML = '<li class="note-item small">No notes yet.</li>';
        return;
      }
      notesEl.innerHTML = notes.map(n => `
        <li class="note-item">
          <div class="note-title">${n.title}</div>
          <div class="note-content">${n.content}</div>
          <div class="small">Updated ${new Date(n.created_at).toLocaleString()}</div>
          <div class="entry-actions">
            <button class="ghost-btn" data-edit-id="${n.id}" data-title="${encodeURIComponent(n.title)}" data-content="${encodeURIComponent(n.content)}">Edit</button>
            <button class="ghost-btn danger" data-delete-id="${n.id}">Delete</button>
          </div>
        </li>
      `).join("");
    }

    async function loadNotes() {
      errorEl.textContent = "";
      try {
        const res = await fetch("/api/notes");
        if (!res.ok) throw new Error("Failed to load notes");
        const data = await res.json();
        renderNotes(data);
      } catch (err) {
        errorEl.textContent = err.message;
      }
    }

    async function saveNote() {
      const title = titleInput.value.trim();
      const content = contentInput.value.trim();
      if (!title || !content) {
        errorEl.textContent = "Title and content are required.";
        return;
      }
      errorEl.textContent = "";
      saveBtn.disabled = true;
      saveBtn.textContent = editingId ? "Updating..." : "Saving...";
      try {
        const method = editingId ? "PUT" : "POST";
        const url = editingId ? `/api/notes/${editingId}` : "/api/notes";
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, content }),
        });
        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(errData.detail || "Failed to save note");
        }
        const data = await res.json();
        titleInput.value = "";
        contentInput.value = "";
        editingId = null;
        saveBtn.textContent = "Save note";
        renderNotes(data);
      } catch (err) {
        errorEl.textContent = err.message;
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = editingId ? "Update note" : "Save note";
      }
    }

    async function deleteNote(id) {
      errorEl.textContent = "";
      saveBtn.disabled = true;
      try {
        const res = await fetch(`/api/notes/${id}`, { method: "DELETE" });
        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(errData.detail || "Failed to delete note");
        }
        const data = await res.json();
        // If deleting the one currently being edited, reset.
        if (editingId && Number(editingId) === Number(id)) {
          editingId = null;
          titleInput.value = "";
          contentInput.value = "";
          saveBtn.textContent = "Save note";
        }
        renderNotes(data);
      } catch (err) {
        errorEl.textContent = err.message;
      } finally {
        saveBtn.disabled = false;
      }
    }

    saveBtn.addEventListener("click", saveNote);
    titleInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && (e.metaKey || e.ctrlKey)) {
        saveNote();
      }
    });

    notesEl.addEventListener("click", (e) => {
      const editBtn = e.target.closest("[data-edit-id]");
      const deleteBtn = e.target.closest("[data-delete-id]");
      if (editBtn) {
        const id = editBtn.getAttribute("data-edit-id");
        const title = decodeURIComponent(editBtn.getAttribute("data-title"));
        const content = decodeURIComponent(editBtn.getAttribute("data-content"));
        editingId = id;
        titleInput.value = title;
        contentInput.value = content;
        saveBtn.textContent = "Update note";
        return;
      }
      if (deleteBtn) {
        const id = deleteBtn.getAttribute("data-delete-id");
        deleteNote(id);
      }
    });

    loadNotes();
  </script>
</body>
</html>
